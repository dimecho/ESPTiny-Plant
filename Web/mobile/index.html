<!DOCTYPE html>
<html>
    <head>
        <title>tiny plant - mobile</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="../css/tailwind.css">
        <link rel="stylesheet" type="text/css" href="css/rslider.css">
        <script src="js/rslider.js"></script>
        <script defer src="../js/common.js"></script>
        <script>
        document.addEventListener('DOMContentLoaded', function(event)
        {
            var nvram = new XMLHttpRequest();
            nvram.responseType = 'json';
            nvram.open('GET', '/nvram.json', true);
            nvram.send();
            nvram.onload = function(e) {
                if(nvram.response != undefined) {
                        
                    if(nvram.response['nvram'][0].indexOf('esp32') != -1) {
                        ESP32 = true;
                    }

                    var moistureSlider = new rSlider({
                        target: '#moisture',
                        values: Array.from({ length: 1025 }, (_, i) => i),
                        range: false,
                        tooltip: true,
                        scale: false,
                        labels: false,
                        step: 1,
                        set: [parseInt(nvram.response['nvram'][PLANT_SOIL_MOISTURE])],
                        onChange: function (v) {
                            saveSetting(PLANT_SOIL_MOISTURE, v);
                        }
                    });

                    var potSlider = new rSlider({
                        target: '#pot',
                        values: Array.from({ length: 121 }, (_, i) => i),
                        range: false,
                        tooltip: true,
                        scale: false,
                        labels: false,
                        step: 1,
                        set: [parseInt(nvram.response['nvram'][PLANT_POT_SIZE])],
                        onChange: function (v) {
                            saveSetting(PLANT_POT_SIZE, v);
                        }
                    });

                    var sleepMax = 30;
                    if(ESP32) {
                        sleepMax = 1440;
                    }
                    var powerSlider = new rSlider({
                        target: '#power',
                        values: Array.from({ length: sleepMax + 1}, (_, i) => i),
                        range: false,
                        tooltip: true,
                        scale: false,
                        labels: false,
                        step: 1,
                        set: [parseInt(nvram.response['nvram'][DEEP_SLEEP])],
                        onChange: function (v) {
                            if(v == 0) {
                                notify('', 'Sleep Disabled!', 'danger');
                                notify('', 'Wireless Always On', 'success');
                                //notify('', 'Battery Will Discharge Quickly!', 'warning');
                            }else if(v < 5) {
                                notify('', 'Low Sleep = High Power Consumption!', 'warning');
                                notify('', 'Sleep > 5 Minutes Recommended', 'success');
                            }
                            if(v == 0) {
                                saveSetting(DEEP_SLEEP, 1);
                            }else{
                                saveSetting(DEEP_SLEEP, v);
                            }
                        }
                    });

                    var timerSlider = new rSlider({
                        target: '#timer',
                        values: Array.from({ length: 101 }, (_, i) => i),
                        range: false,
                        tooltip: true,
                        scale: false,
                        labels: false,
                        step: 1,
                        set: [parseInt(nvram.response['nvram'][PLANT_MANUAL_TIMER])],
                        onChange: function (v) {
                            saveSetting(PLANT_MANUAL_TIMER, v, function(lock) {
                                if (lock != 'Locked') {
                                    if (v == 0) {
                                        moistureSlider.disabled(false);
                                        //powerSlider.setValues(4);
                                    }else{
                                        moistureSlider.disabled(true);
                                        notify('', 'Timer disables Soil Sensor', 'danger');
                                        if(v < 8) //less than 8 hours
                                            notify('', 'Timer is Low! No Overwater protection', 'warning');
                                        notify('', 'Enable when issues with Sensor', 'info');
                                    }
                                }
                            });
                        }
                    });

                    var soilSlider = new rSlider({
                        target: '#soil',
                        values: soil_type_labels,
                        range: false,
                        tooltip: false,
                        scale: true,
                        labels: true,
                        step: 1,
                        set: [soil_type_labels[nvram.response['nvram'][PLANT_SOIL_TYPE]]],
                        onChange: function (v) {
                            console.log(v);
                        }
                    });

                    var water = new XMLHttpRequest();
                    water.open('GET', '/api?adc=2', true);
                    water.send();
                    water.onloadend = function() {
                        if(water.status == 200) {
                            var a = parseInt(water.responseText);
                            new rSlider({
                                target: '#water',
                                values: [0,25,50,75,100],
                                range: false,
                                tooltip: false,
                                scale: true,
                                labels: true,
                                step: 25,
                                set: [a]
                            });
                            /*
                            var pnp_adc = nvram.response['nvram'][PNP_ADC] + '000';
                            */
                        }
                    }
          
                    if(nvram.response['nvram'][DEMO_PASSWORD] != '')
                    {
                        DEMOLOCK = true;
                    }

                    if(nvram.response['nvram'][LOG_ENABLE] == 1) {
                        notify('', 'Data collection is enabled.', 'info');
                    }
                }
            }
        });
        </script>
    </head>
    <body class="bg-gray-100">
        <div class="fixed top-0 right-0 p-3 z-[2000]" id="notify"></div>
        <div class="fixed inset-0 bg-black opacity-50 hidden" id="modal-backdrop"></div>
        <div class="items-center justify-center p-4">
            <button type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded w-full py-2 mt-4" onclick="">Graph</button>
            <button type="button" class="bg-gray-400 hover:bg-gray-500 text-white rounded w-full py-2 mt-4" onclick="window.location.href='wifi.html'">Settings</button>
            <div class="bg-white border border-gray-300 rounded-[5px] mt-4 mb-4">
                <div class="p-4">Timer (Pump Hours)</div>
                <div class="p-6"><input type="text" id="timer" name="timer" class="slider"></div>
            </div>
            <div class="bg-white border border-gray-300 rounded-[5px] mb-4">
                <div class="p-4">Moisture (Soil Sensor)</div>
                <div class="p-6"><input type="text" id="moisture" name="moisture" class="slider"></div>
            </div>
            <div class="bg-white border border-gray-300 rounded-[5px] mb-4">
                <div class="p-4">Pot Size (Pump Seconds)</div>
                <div class="p-6"><input type="text" id="pot" name="pot" class="slider"></div>
            </div>
            <div class="bg-white border border-gray-300 rounded-[5px] mb-4">
                <div class="p-4">Power (Sleep Minutes)</div>
                <div class="p-6"><input type="text" id="power" name="power" class="slider"></div>
            </div>
            <div class="bg-white border border-gray-300 rounded-[5px] mb-4">
                <div class="p-4">Soil Type</div>
                <div class="p-6"><input type="text" id="soil" name="soil" class="slider"></div>
            </div>
            <div class="bg-white border border-gray-300 rounded-[5px] mb-4">
                <div class="p-4">Water Level (Full %)</div>
                <div class="p-6"><input type="text" id="water" name="water" class="slider"></div>
            </div>
        </div>
        <div class="fixed inset-0 flex items-center justify-center hidden modal" id="demo-lock">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg w-full max-w-md mx-auto border border-gray-600 dark:border-gray-300">
                <div class="flex modal-header justify-between items-center border-b border-gray-600 dark:border-gray-300">
                    <h5 class="text-lg font-semibold text-gray-800 dark:text-white">Login</h5>
                    <button id="close-modal" class="text-gray-500 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-300 focus:outline-none text-2xl" onclick="hideModal(this)">&times;</button>
                </div>
                <form method="POST" action="/login" id="demo-lock-form">
                    <input type="password" id="DemoPassword" name="password" class="border border-gray-300 dark:border-gray-600 focus:ring focus:ring-green-500 rounded-md p-2 w-full" placeholder="Password" required>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white rounded w-full px-4 py-2 mt-4" id="demo-lock-ok">Login</button>
                </form>
            </div>
        </div>
    </body>
</html>